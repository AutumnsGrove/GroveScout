# Scout - Cloudflare Workers Configuration
# Internal codename: Research Goblin

name = "scout"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]

# Main entry point (SvelteKit handles this)
main = ".svelte-kit/cloudflare/_worker.js"
assets = { directory = ".svelte-kit/cloudflare", binding = "ASSETS" }

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "scout-db"
database_id = "6a289378-c662-4c6a-9f1b-fa5296e03fa2" # Run: npx wrangler d1 create scout-db

# KV Namespace for caching and sessions
[[kv_namespaces]]
binding = "KV"
id = "31eb5622c7fd41ec8fc8c8f939f5099b" # Run: npx wrangler kv:namespace create SCOUT_CACHE

# R2 Bucket for long-term result storage
# Results migrate from D1 to R2 after 7 days as markdown files
[[r2_buckets]]
binding = "R2"
bucket_name = "scout-results"
# Run: npx wrangler r2 bucket create scout-results

# Durable Object for advanced search job orchestration
[[durable_objects.bindings]]
name = "SEARCH_JOB"
class_name = "SearchJobDO"

# SQLite migrations for Durable Objects
[[migrations]]
tag = "v1"
new_sqlite_classes = ["SearchJobDO"]

# Queue for async search jobs (producer only - consumer needs separate worker)
# Note: Consumer disabled until we create a dedicated queue worker
# For now, searches run synchronously via the fallback in +server.ts
# [[queues.producers]]
# queue = "scout-search-jobs"
# binding = "SEARCH_QUEUE"

# Scheduled trigger for D1 â†’ R2 migration (runs daily at 3am UTC)
[triggers]
crons = ["0 3 * * *"]

# Environment variables (secrets set via wrangler secret put)
# ANTHROPIC_API_KEY - Claude API key
# BRAVE_API_KEY - Brave Search API key
# STRIPE_SECRET_KEY - Stripe secret key
# STRIPE_WEBHOOK_SECRET - Stripe webhook signing secret
# RESEND_API_KEY - Email API key
# GOOGLE_CLIENT_ID - Google OAuth client ID
# GOOGLE_CLIENT_SECRET - Google OAuth client secret
# APPLE_CLIENT_ID - Apple Sign-In client ID
# APPLE_TEAM_ID - Apple Team ID
# APPLE_KEY_ID - Apple Key ID
# APPLE_PRIVATE_KEY - Apple Sign-In private key

[vars]
ENVIRONMENT = "development"
SITE_URL = "http://localhost:5173"

# Production overrides
[env.production]
name = "scout"

# D1 Database (production)
[[env.production.d1_databases]]
binding = "DB"
database_name = "scout-db"
database_id = "6a289378-c662-4c6a-9f1b-fa5296e03fa2"

# KV Namespace (production)
[[env.production.kv_namespaces]]
binding = "KV"
id = "31eb5622c7fd41ec8fc8c8f939f5099b"

# R2 Bucket (production)
[[env.production.r2_buckets]]
binding = "R2"
bucket_name = "scout-results"

# Durable Object (production) - must be explicitly defined per environment
[[env.production.durable_objects.bindings]]
name = "SEARCH_JOB"
class_name = "SearchJobDO"

# SQLite migrations for Durable Objects (production)
[[env.production.migrations]]
tag = "v1"
new_sqlite_classes = ["SearchJobDO"]

[env.production.vars]
ENVIRONMENT = "production"
SITE_URL = "https://scout.grove.place"
